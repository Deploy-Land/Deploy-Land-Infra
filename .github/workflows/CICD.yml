name: Terraform CICD

on:
  pull_request:
    branches:
      - main

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  terraform:
    name: 'Terraform CICD'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: 'ap-northeast-2'
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: 'GitHubActions-Terraform-Session'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Install tfsec
        run: |
          sudo curl -L -o /usr/local/bin/tfsec https://github.com/aquasecurity/tfsec/releases/download/v1.28.1/tfsec-linux-amd64
          sudo chmod +x /usr/local/bin/tfsec

      # =============================
      # Run for each module sequentially
      # =============================
      - name: Run Terraform for each module
        id: run_modules
        run: |
          for dir in ecr apprunner codepipeline; do
            echo "===== Processing $dir ====="
            cd $dir

            echo "Running tfsec..."
            tfsec . --format=default > ../tfsec_${dir}.txt || true

            echo "Terraform init..."
            terraform init -no-color > ../init_${dir}.txt 2>&1 || true

            echo "Terraform plan..."
            terraform plan -no-color -out=tfplan > ../plan_${dir}.txt 2>&1 || true

            echo "Terraform apply..."
            terraform apply -auto-approve -no-color tfplan > ../apply_${dir}.txt 2>&1 || true

            cd ..
          done

      # =============================
      # Summary Comment
      # =============================
      - name: Create or Update PR Comment
        uses: actions/github-script@v7
        if: always() && github.event.pull_request
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const dirs = ['ecr', 'apprunner', 'codepipeline'];

            const createSection = (dir, type) => {
              const content = require('fs').readFileSync(`${type}_${dir}.txt`, 'utf8');
              const status = content.includes("Error") ? "‚ùå" : "‚úÖ";
              return `<details><summary>${status} ${type} (${dir})</summary>\n\n${content}\n</details>`;
            };

            let body = "## Terraform CICD Results ü§ñ\n\n";
            for (const dir of dirs) {
              body += `### üìÅ ${dir}\n`;
              body += createSection(dir, 'tfsec');
              body += createSection(dir, 'init');
              body += createSection(dir, 'plan');
              body += createSection(dir, 'apply');
              body += "\n";
            }

            const pr_number = context.issue.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
            });

            const botComment = comments.find(comment =>
              comment.user.login === 'github-actions[bot]' && comment.body.includes("Terraform CICD Results")
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
                body: body,
              });
            }